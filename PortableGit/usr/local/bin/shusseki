#!/bin/bash

GB='\e[1;32m'
GE='\e[m'
RB='\e[1;31m'
RE='\e[m'

echo "出席スクリプトを起動します．"
echo "今日の意気込みを一言入力してください（1行のみ）． "
echo -n "> "
read input

trap "echo '授業を終了します';rm ~/kadai/.??*; exit 0" 2 15

[ ! -d ~/kadai ] && mkdir -p ~/kadai
echo "`date +'%Y-%m-%dT%H:%M:%S'` ${IPADDR} : $input" >> ~/kadai/`/usr/local/bin/course`/.message.txt


echo "==== 今からputkadaiコマンドで定期的に課題を提出します ===="
INTERVAL="5"
find ~/kadai -not -name '.*' -not -name '*.class' -ls > ~/kadai/.found
while :; do
    find ~/kadai -not -name '.*' -not -name '*.class' -ls > ~/kadai/.tmp
    if diff ~/kadai/.tmp ~/kadai/.found > /dev/null; then
      sleep $INTERVAL
    else
      /usr/local/bin/putkadai > ~/kadai/.put
      if [ $? -gt 0 ]; then
        echo -e "${RB}rsyncは失敗しました．${RE}$INTERVAL秒後に再実行します． `date`"
        sleep $INTERVAL
      else
        #cat ~/kadai/.put
        grep -v '/\.' ~/kadai/.put
        echo -e "${GB}rsyncは成功しました${GE} `date`"
        cp ~/kadai/.tmp ~/kadai/.found
      fi
    fi
done
