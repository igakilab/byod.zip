#!/bin/bash

GB='\e[1;32m'
GE='\e[m'
RB='\e[1;31m'
RE='\e[m'

echo "出席スクリプトを起動します．"
echo "これは演習の課題ファイルが作成・編集されるたびにそのファイルを自動的にサーバに提出するスクリプトです．"
echo "授業開始後はずっと起動しておいてください．"
echo "Ctr+Cで終了できます．"
#echo -n "> "
#read input

trap "echo '授業を終了します';rm ~/kadai/.??*; exit 0" 2 15

[ ! -d ~/kadai ] && mkdir -p ~/kadai
echo "`date +'%Y-%m-%dT%H:%M:%S'` ${IPADDR} : $input" >> ~/kadai/`/usr/local/bin/course`/.message.txt


echo "==== 今からputkadaiコマンドで定期的に課題を提出します ===="
INTERVAL="5"
find ~/kadai/`/usr/local/bin/course`/ -not -name '.*' -not -name '*.class' -ls > ~/kadai/.found
while :; do
    find ~/kadai/`/usr/local/bin/course`/ -not -name '.*' -not -name '*.class' -ls > ~/kadai/.tmp
    if diff ~/kadai/.tmp ~/kadai/.found > /dev/null; then
      sleep $INTERVAL
    else
      #echo `diff ~/kadai/.tmp ~/kadai/.found`
      /usr/local/bin/putkadai
      if [ $? -le 1 ]; then
        cp ~/kadai/.tmp ~/kadai/.found
      fi
    fi
done
