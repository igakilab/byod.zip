#!/bin/sh
#
# Written by Yasuharu Mizutani

#
# ユーザ名の入力
#
echo -n "e1で始まるユーザ名を入力してください: "
read id
case "${id}" in
  e1??????|t???????)
    ;;
  *)
    echo "ユーザ名が e1xxxxxx の形式（e1の後に5桁の数字）ではありません"
    exit 1
esac


#
# .sshディレクトリの作成
#
if [ ! -d ~/.ssh ]; then
    mkdir -p ~/.ssh
fi
echo "StrictHostKeyChecking no" > ~/.ssh/config

#
# 鍵の生成
#
eval PUBKEY="~/.ssh/id_rsa.pub"
eval PRIKEY="~/.ssh/id_rsa"
if [ -f "${PUBKEY}" -a -f "${PRIKEY}" ]; then
    :
else
    echo "今からエンターキーを3回押してください"
    sleep 0.2
    ssh-keygen -t rsa -f "$HOME"/.ssh/id_rsa
fi

#
# 鍵認証の設定とユーザ名の登録
#
RHOST="`getkadaihost`"
RCOMM="
    mkdir -p -m 700 .ssh;
    grep -v '`hostname`' .ssh/authorized_keys > .ssh/tmp;
    mv .ssh/tmp .ssh/authorized_keys;
    cat >> .ssh/authorized_keys;
    chmod 600 .ssh/authorized_keys
    mkdir -p -m 705 kadai;
"
echo ""
echo "演習室のパスワードを入力してください"
if cat "${PUBKEY}" | ssh "${id}@${RHOST}" "${RCOMM}"; then
    echo "${id}" > ~/.oitname
    echo "成功しました"
else
    echo "失敗しました"
    exit 1
fi


exit 0
